{% extends "shared/custom_base.html" %}
<!--begin::Wrapper-->
{% block content %}
<div class="app-wrapper flex-column flex-row-fluid" id="kt_app_wrapper">
  <!--begin::Main-->
  <div class="app-main flex-column flex-row-fluid" id="kt_app_main">
    <!--begin::Content wrapper-->
    <div class="d-flex flex-column flex-column-fluid">
      <!--begin::Content-->
      <div id="kt_app_content" class="app-content flex-column-fluid">
        <!--begin::Content container-->
        <div id="kt_app_content_container" class="app-container container-xxl">
          <!--begin::Layout-->
          <div class="d-flex flex-column flex-xl-row">
            <!--begin::Content-->
            <div class="d-flex flex-row-fluid me-xl-9 mb-10 mb-xl-0">
              <!--begin::Pos food-->
              <div class="card card-flush card-p-0 bg-transparent border-0">
                <!--begin::Body-->
                <div class="card-body">
                  <!--begin::Nav-->
                  <ul
                    class="nav nav-pills d-flex justify-content-between nav-pills-custom gap-3 mb-6"
                  >
                    <!--begin::Item-->
                    <li class="nav-item mb-3 me-0">
                      <!--begin::Nav link-->
                      <a
                        class="nav-link nav-link-border-solid btn btn-outline btn-flex btn-active-color-primary flex-column flex-stack pt-9 pb-7 page-bg show active"
                        data-bs-toggle="pill"
                        href="#kt_pos_food_content_1"
                        style="width: 138px; height: 180px"
                      >
                        <!--begin::Icon-->
                        <div class="nav-icon mb-3">
                          <!--begin::Food icon-->
                          <img
                            src="static/assets/media/svg/food-icons/spaghetti.svg"
                            class="w-50px"
                            alt=""
                          />
                          <!--end::Food icon-->
                        </div>
                        <!--end::Icon-->
                        <!--begin::Info-->
                        <div class="">
                          <span class="text-gray-800 fw-bold fs-2 d-block"
                            >主食</span
                          >

                          <span class="text-gray-500 fw-semibold fs-7"
                            >{{menu_items | length }} 道主食</span
                          >
                        </div>
                        <!--end::Info-->
                      </a>

                      <!--end::Nav link-->
                    </li>
                    <!--end::Item-->
                  </ul>
                  <!--end::Nav-->
                  <!--begin::Tab Content-->
                  <div class="tab-content">
                    <!--begin::Tap pane-->
                    <div
                      class="tab-pane fade show active"
                      id="kt_pos_food_content_1"
                    >
                      <!--begin::Wrapper-->
                      <div class="d-flex flex-wrap d-grid gap-5 gap-xxl-9">
                        <!--begin::Card-->
                        {% for item in menu_items %}
                        <div
                          class="card card-flush flex-row-fluid p-6 pb-5 mw-100"
                          data-name="{{ item.name }}"
                          data-price="{{ item.price | int}}"
                          data-description="{{ item.description}}"
                          data-img
                        >
                          <!--begin::Body-->
                          <div class="card-body text-center">
                            <!--begin::Food img-->
                            <img
                              src="static/assets/media/stock/food/img-2.jpg"
                              class="rounded-3 mb-4 w-150px h-150px w-xxl-200px h-xxl-200px"
                              alt=""
                            />
                            <!--end::Food img-->
                            <!--begin::Info-->
                            <div class="mb-2">
                              <!--begin::Title-->
                              <div class="text-center">
                                <span
                                  class="fw-bold text-gray-800 cursor-pointer text-hover-primary fs-3 fs-xl-1"
                                  >{{ item.name }}</span
                                >
                                <span
                                  class="text-gray-500 fw-semibold d-block fs-6 mt-n1"
                                  >{{ item.description }}</span
                                >
                              </div>
                              <!--end::Title-->
                            </div>
                            <!--end::Info-->
                            <!--begin::Total-->
                            <span class="text-success text-end fw-bold fs-1"
                              >價格： ${{ item.price | int }}</span
                            >
                            <br />
                            <span class="text-black text-end fs-6">
                              {{ '供應中' if item.available else '已售完'
                              }}</span
                            >
                            <!--end::Total-->
                          </div>
                          <!--end::Body-->
                        </div>
                        {% endfor %}
                        <!--end::Card-->
                      </div>
                      <!--end::Wrapper-->
                    </div>
                    <!--end::Tap pane-->
                  </div>
                  <!--end::Tab Content-->
                </div>
                <!--end: Card Body-->
              </div>
              <!--end::Pos food-->
            </div>
            <!--end::Content-->
            <!--begin::Sidebar-->
            <div class="flex-row-auto w-xl-450px">
              <!--begin::Pos order-->
              <div class="card card-flush bg-body" id="kt_pos_form">
                <!--begin::Header-->
                <div class="card-header pt-5">
                  <h3 class="card-title fw-bold text-gray-800 fs-2qx">
                    今日訂單
                  </h3>
                  <!--begin::Toolbar-->
                  <div class="card-toolbar">
                    <a
                      class="btn btn-light-primary fs-4 fw-bold py-4"
                      id="clearAll"
                      >清空全部</a
                    >
                  </div>
                  <!--end::Toolbar-->
                </div>
                <!--end::Header-->
                <!--begin::Body-->
                <div class="card-body pt-0">
                  <!--begin::Table container-->
                  <div class="table-responsive mb-8">
                    <!--begin::Table-->
                    <table class="table align-middle gs-0 gy-4 my-0">
                      <!--begin::Table head-->
                      <thead>
                        <tr>
                          <th class="min-w-175px"></th>
                          <th class="w-125px"></th>
                          <th class="w-60px"></th>
                        </tr>
                      </thead>
                      <!--end::Table head-->
                      <!--begin::Table body-->
                      <tbody id="shopping-cartlist">
                        <!--js動態生成-->
                      </tbody>
                      <!--end::Table body-->
                    </table>
                    <!--end::Table-->
                  </div>
                  <!--end::Table container-->
                  <!--begin::Summary-->
                  <div class="d-flex flex-stack bg-success rounded-3 p-6 mb-11">
                    <!--begin::Content-->
                    <div class="fs-6 fw-bold text-white">
                      <span class="d-block fs-2qx lh-1">總價格</span>
                    </div>
                    <!--end::Content-->
                    <!--begin::Content-->
                    <div class="fs-6 fw-bold text-white text-end">
                      <span
                        class="d-block fs-2qx lh-1"
                        data-kt-pos-element="grant-total"
                        >$0</span
                      >
                    </div>
                    <!--end::Content-->
                  </div>
                  <!--end::Summary-->
                  <!--begin::Payment Method-->
                  <div class="m-0">
                    <!--begin::Title-->
                    <h1 class="fw-bold text-gray-800 mb-5">付款方式</h1>
                    <!--end::Title-->
                    <!--begin::Radio group-->
                    <div
                      class="d-flex flex-equal gap-5 gap-xxl-9 px-0 mb-12"
                      data-kt-buttons="true"
                      data-kt-buttons-target="[data-kt-button]"
                    >
                      <!--begin::Radio-->
                      <label
                        class="btn bg-light btn-color-gray-600 btn-active-text-gray-800 border border-3 border-gray-100 border-active-primary btn-active-light-primary w-100 px-4"
                        data-kt-button="true"
                      >
                        <!--begin::Input-->
                        <input
                          class="btn-check"
                          type="radio"
                          name="payment-method"
                          value="linepay"
                        />
                        <!--end::Input-->
                        <!--begin::Icon-->
                        <i class="ki-duotone ki-dollar fs-2hx mb-2 pe-0">
                          <span class="path1"></span>
                          <span class="path2"></span>
                          <span class="path3"></span>
                        </i>
                        <!--end::Icon-->
                        <!--begin::Title-->
                        <span class="fs-7 fw-bold d-block">Linepay</span>
                        <!--end::Title-->
                      </label>
                      <!--end::Radio-->
                      <!--begin::Radio-->
                      <label
                        class="btn bg-light btn-color-gray-600 btn-active-text-gray-800 border border-3 border-gray-100 border-active-primary btn-active-light-primary w-100 px-4 active"
                        data-kt-button="true"
                      >
                        <!--begin::Input-->
                        <input
                          class="btn-check"
                          type="radio"
                          name="payment-method"
                          value="creditcard"
                        />
                        <!--end::Input-->
                        <!--begin::Icon-->
                        <i class="ki-duotone ki-credit-cart fs-2hx mb-2 pe-0">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        <!--end::Icon-->
                        <!--begin::Title-->
                        <span class="fs-7 fw-bold d-block">信用卡</span>
                        <!--end::Title-->
                      </label>
                      <!--end::Radio-->
                      <!--begin::Radio-->
                      <label
                        class="btn bg-light btn-color-gray-600 btn-active-text-gray-800 border border-3 border-gray-100 border-active-primary btn-active-light-primary w-100 px-4"
                        data-kt-button="true"
                      >
                        <!--begin::Input-->
                        <input
                          class="btn-check"
                          type="radio"
                          name="payment-method"
                          value="visacard"
                        />
                        <!--end::Input-->
                        <!--begin::Icon-->
                        <i class="ki-duotone ki-paypal fs-2hx mb-2 pe-0">
                          <span class="path1"></span>
                          <span class="path2"></span>
                        </i>
                        <!--end::Icon-->
                        <!--begin::Title-->
                        <span class="fs-7 fw-bold d-block">Visa Card</span>
                        <!--end::Title-->
                      </label>
                      <!--end::Radio-->
                    </div>
                    <!--end::Radio group-->
                    <!--begin::Actions-->
                    <button
                      type="button"
                      class="btn btn-primary fs-1 w-100 py-4"
                      id="checkout"
                    >
                      結帳
                    </button>
                    <!--end::Actions-->
                  </div>
                  <!--end::Payment Method-->
                </div>
                <!--end: Card Body-->
              </div>
              <!--end::Pos order-->
            </div>
            <!--end::Sidebar-->
          </div>
          <!--end::Layout-->
        </div>
        <!--end::Content container-->
      </div>
      <!--end::Content-->
    </div>
    <!--end::Content wrapper-->
    <!--begin::Footer-->
    <div id="kt_app_footer" class="app-footer">
      <!--begin::Footer container-->
      <div
        class="app-container container-fluid d-flex flex-column flex-md-row flex-center flex-md-stack py-3"
      >
        <!--begin::Copyright-->
        <div class="text-gray-900 order-2 order-md-1">
          <span class="text-muted fw-semibold me-1">2024&copy;</span>
          <a
            href="https://keenthemes.com"
            target="_blank"
            class="text-gray-800 text-hover-primary"
            >Keenthemes</a
          >
        </div>
        <!--end::Copyright-->
        <!--begin::Menu-->
        <ul class="menu menu-gray-600 menu-hover-primary fw-semibold order-1">
          <li class="menu-item">
            <a
              href="https://keenthemes.com"
              target="_blank"
              class="menu-link px-2"
              >About</a
            >
          </li>
          <li class="menu-item">
            <a
              href="https://devs.keenthemes.com"
              target="_blank"
              class="menu-link px-2"
              >Support</a
            >
          </li>
          <li class="menu-item">
            <a
              href="https://1.envato.market/EA4JP"
              target="_blank"
              class="menu-link px-2"
              >Purchase</a
            >
          </li>
        </ul>
        <!--end::Menu-->
      </div>
      <!--end::Footer container-->
    </div>
    <!--end::Footer-->
  </div>
  <!--end:::Main-->
</div>
<!--end::Wrapper-->
<!--begin::Scrolltop-->
<div id="kt_scrolltop" class="scrolltop" data-kt-scrolltop="true">
  <i class="ki-duotone ki-arrow-up">
    <span class="path1"></span>
    <span class="path2"></span>
  </i>
</div>
{% endblock content %}
<!--js-->
{% block script %}
<!--begin::Javascript-->
<script>
  var hostUrl = "static/assets/";
</script>
<!--begin::Global Javascript Bundle(mandatory for all pages)-->
<script src="static/assets/plugins/global/plugins.bundle.js"></script>
<script src="static/assets/js/scripts.bundle.js"></script>
<!--end::Global Javascript Bundle-->
<!--begin::Vendors Javascript(used for this page only)-->
<script src="static/assets/plugins/custom/datatables/datatables.bundle.js"></script>
<!--end::Vendors Javascript-->
<!--begin::Custom Javascript(used for this page only)-->
<script src="static/assets/js/custom/pages/general/pos.js"></script>
<script src="static/assets/js/widgets.bundle.js"></script>
<script src="static/assets/js/custom/widgets.js"></script>
<script src="static/assets/js/custom/apps/chat/chat.js"></script>
<script src="static/assets/js/custom/utilities/modals/upgrade-plan.js"></script>
<script src="static/assets/js/custom/utilities/modals/users-search.js"></script>
<script>
  //初始化購物車物件 為空陣列
  let cart = [];

  //當 DOM 加載完畢後執行
  document.addEventListener("DOMContentLoaded", function () {
    // 檢查 localStorage 中是否已有 cart 資料
    const storedItem = localStorage.getItem("cart");

    if (storedItem) {
      //如果已經存在 將JSON字串解析為物件 並載入
      cart = JSON.parse(storedItem);
    } else {
      // 如果不存在，將空陣列設為初始值並存入 localStorage
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    // 更新購物車顯示
    updateCartUI();
  });

  // 儲存購物車至 localStorage
  function saveCartToLocalStorage() {
    localStorage.setItem("cart", JSON.stringify(cart));
    console.log(cart);
  }

  // 點擊卡片加入購物車功能
  document
    .getElementById("kt_pos_food_content_1")
    .addEventListener("click", function (event) {
      const menuCard = event.target.closest(".card.card-flush");

      if (menuCard) {
        const name = menuCard.getAttribute("data-name");
        const price = Number(menuCard.getAttribute("data-price"));
        const description = menuCard.getAttribute("data-description");

        const data = { name, price, description };
        addToCart(data);
      }
    });

  // 加入購物車邏輯
  function addToCart(item) {
    console.log(`${item.name} 加入購物車，價格: ${item.price}`);
    const existingItem = cart.find((cartItem) => cartItem.name === item.name);

    if (existingItem) {
      existingItem.quantity += 1;
    } else {
      item.quantity = 1;
      cart.push(item);
    }
    saveCartToLocalStorage(); // 加入商品後儲存
    updateCartUI();
  }

  // 更新購物車顯示
  function updateCartUI() {
    const cartlist = document.getElementById("shopping-cartlist");
    cartlist.innerHTML = ""; // 清空購物車顯示

    cart.forEach((item) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td class="pe-0">
          <div class="d-flex align-items-center">
            <img src="static/assets/media/stock/food/img-2.jpg" class="w-50px h-50px rounded-3 me-3" alt="" />
            <span class="fw-bold text-gray-800 cursor-pointer text-hover-primary fs-4 me-1">${
              item.name
            }</span>
          </div>
        </td>
        <td class="pe-0">
          <div class="position-relative d-flex align-items-center">
            <span class="d-flex align-items-center">單價：${item.price}</span>
            <button type="button" class="btn btn-icon btn-sm btn-light" data-action="decrease" data-name="${
              item.name
            }">
              <i class="ki-duotone ki-minus fs-3x"></i>
            </button>
            <input style="width: 50px; text-align: center; border: none; outline: none;" type="text" class="form-control text-center" readonly value="${
              item.quantity
            }" />
            <button type="button" class="btn btn-icon btn-sm btn-light" data-action="increase" data-name="${
              item.name
            }">
              <i class="ki-duotone ki-plus fs-3x"></i>
            </button>
          </div>
        </td>
        <td class="text-end"><span class="fw-bold text-primary fs-2">$${
          item.price * item.quantity
        }元</span></td>
      `;
      cartlist.appendChild(row);
    });

    const total = cart.reduce(
      (acc, item) => acc + item.price * item.quantity,
      0
    );
    document.querySelector(
      "[data-kt-pos-element='grant-total']"
    ).textContent = `$${total.toFixed(2)}`;
  }

  // 增加數量
  function increaseQuantity(name) {
    const item = cart.find((cartItem) => cartItem.name === name);
    if (item) {
      item.quantity += 1;
      saveCartToLocalStorage(); // 增加數量後儲存
      updateCartUI();
    }
  }

  // 減少數量
  function decreaseQuantity(name) {
    const item = cart.find((cartItem) => cartItem.name === name);
    if (item && item.quantity > 1) {
      item.quantity -= 1;
    } else {
      cart = cart.filter((cartItem) => cartItem.name !== name); // 如果數量為0移除
    }
    saveCartToLocalStorage(); // 減少數量後儲存
    updateCartUI();
  }

  // 清空購物車
  function clearCart(e) {
    e.preventDefault();
    cart = [];
    saveCartToLocalStorage(); // 清空購物車後儲存
    updateCartUI();
  }

  // 綁定清空購物車按鈕
  document.getElementById("clearAll").addEventListener("click", clearCart);

  // 綁定增加或減少按鈕的事件委派
  document
    .getElementById("shopping-cartlist")
    .addEventListener("click", function (event) {
      const target = event.target.closest("button");
      if (target) {
        const name = target.getAttribute("data-name");
        const action = target.getAttribute("data-action");

        if (action === "increase") {
          increaseQuantity(name);
        } else if (action === "decrease") {
          decreaseQuantity(name);
        }
      }
    });

  document.getElementById("checkout").addEventListener("click", function () {
    //利用:ckecked 來選擇使用者選取的付款方式
    const paymentMethod = document.querySelector(
      'input[name="payment-method"]:checked'
    ).value;

    if (!paymentMethod) {
      alert("請選擇付款方式");
      return;
    }
    console.log(paymentMethod);

    //獲取購物車內容
    const cart = JSON.parse(localStorage.getItem("cart") || "[]");

    //判斷購物車不能為空
    if (cart.length === 0) {
      alert("購物車是空的，無法結帳");
      return;
    }

    // 檢查使用者登入狀態
    fetch("/customer/check-login-status")
      .then((response) => response.json())
      .then((data) => {
        if (data.logged_in) {
          alert("請先登入");
          // 使用固定的登入頁面 URL 或自訂邏輯生成登入頁面路徑
          window.location.href = "/customer/login";
        } else {
          console.log("已登入");
        }
      });
  });
</script>
{% endblock script %}
